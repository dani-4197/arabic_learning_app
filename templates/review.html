{% extends "base.html" %}

{% block title %}Review - Arabic Learning App{% endblock %}

{% block content %}
<div class="review-container">
    <div class="review-header">
        <h1>Review Session</h1>
        <div class="review-progress">
            <span id="current-card">1</span> / <span id="total-cards">{{ cards|length }}</span>
        </div>
    </div>

    <div class="flashcard-area">
        <div class="flashcard" id="flashcard">
            <div class="flashcard-front">
                <div class="arabic-text" id="arabic-text">
                    {{ cards[0].arabic_term }}
                </div>
                
                <div class="button-group">
                    <button class="btn btn-info mb-2" onclick="playAudioFromCard()">
                        Pronounce üîä
                    </button>
                    <br>
                    <button class="btn btn-secondary" onclick="flipCard()">Show Answer</button>
                </div>
            </div>
            
            <div class="flashcard-back" style="display: none;">
                <div class="arabic-text" id="arabic-text-back">
                    {{ cards[0].arabic_term }}
                </div>
                <button class="btn btn-sm btn-outline-info mb-2" onclick="playAudioFromCard()">
                    Listen Again üîä
                </button>

                <div class="english-text" id="english-text">
                    {{ cards[0].english_translation }}
                </div>
                
                <div class="rating-section">
                    <p class="rating-prompt">How well did you know this?</p>
                    <div class="rating-buttons">
                        <button class="btn-rating btn-forgot" onclick="rateCard(1)">
                            <span class="rating-emoji">üòû</span>
                            <span class="rating-label">Forgot</span>
                        </button>
                        <button class="btn-rating btn-struggled" onclick="rateCard(2)">
                            <span class="rating-emoji">üòê</span>
                            <span class="rating-label">Struggled</span>
                        </button>
                        <button class="btn-rating btn-good" onclick="rateCard(3)">
                            <span class="rating-emoji">üòä</span>
                            <span class="rating-label">Good</span>
                        </button>
                        <button class="btn-rating btn-perfect" onclick="rateCard(4)">
                            <span class="rating-emoji">üéâ</span>
                            <span class="rating-label">Perfect</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="review-stats">
        <div class="stat-item">
            <span class="stat-label">Points Earned:</span>
            <span class="stat-value" id="points-earned">0</span>
        </div>
    </div>
</div>

<script id="cards-data" type="application/json">
{{ cards | tojson }}
</script>

<script>
let cards = JSON.parse(document.getElementById('cards-data').textContent);
let currentIndex = 0;
let totalPoints = 0;
let isFlipped = false;

/**
 * TECHNICAL SOLUTION: Audio Integration
 * This function calls the Flask route /get-audio/ to stream the MP3
 */
function playAudioFromCard() {
    const word = cards[currentIndex].arabic_term;
    // Encode the URI to handle Arabic characters correctly in the URL
    const audio = new Audio(`/get-audio/${encodeURIComponent(word)}`);
    audio.play().catch(e => console.error("Audio Playback Error:", e));
}

function updateCard() {
    if (currentIndex >= cards.length) {
        showCompletionMessage();
        return;
    }
    
    const card = cards[currentIndex];
    document.getElementById('arabic-text').textContent = card.arabic_term;
    document.getElementById('arabic-text-back').textContent = card.arabic_term;
    document.getElementById('english-text').textContent = card.english_translation;
    document.getElementById('current-card').textContent = currentIndex + 1;
    
    document.querySelector('.flashcard-front').style.display = 'block';
    document.querySelector('.flashcard-back').style.display = 'none';
    isFlipped = false;

    // OPTIONAL: Auto-play audio when card is shown (Top Band UX)
    // playAudioFromCard(); 
}

function flipCard() {
    document.querySelector('.flashcard-front').style.display = 'none';
    document.querySelector('.flashcard-back').style.display = 'block';
    isFlipped = true;
}

async function rateCard(score) {
    if (!isFlipped) {
        alert('Please reveal the answer first!');
        return;
    }
    
    const card = cards[currentIndex];
    
    try {
        const response = await fetch('/api/review_card', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                card_id: card.card_id,
                score: score
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            totalPoints += result.points_earned;
            document.getElementById('points-earned').textContent = totalPoints;
            currentIndex++;
            updateCard();
        } else {
            alert('Error updating card: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

function showCompletionMessage() {
    const flashcardArea = document.querySelector('.flashcard-area');
    flashcardArea.innerHTML = `
        <div class="completion-message" style="text-align:center; padding: 50px;">
            <h2>üéâ Session Complete!</h2>
            <p>You earned <strong>${totalPoints}</strong> points</p>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">Back to Dashboard</a>
        </div>
    `;
}

// Keyboard shortcuts for Accessibility (AO3b High Band)
document.addEventListener('keydown', function(e) {
    const key = e.key.toLowerCase();

    // 'p' or 'a' for Pronunciation
    if (key === 'p' || key === 'a') {
        playAudioFromCard();
    }

    if (isFlipped) {
        if (['1', '2', '3', '4'].includes(key)) {
            rateCard(parseInt(key));
        }
    } else if (key === ' ' || key === 'enter') {
        e.preventDefault();
        flipCard();
    }
});
</script>
{% endblock %}
